#__author__ = 'generated by py-ui4win'

import string, os, time
import threading
from ctypes import *
import json

from PyFrameBase import *
from CommonUtil import *

WM_FROM_JS = 0x0400
WM_FROM_IEWEBBROWSER = 0x0401


class BrowserEventHandler(CWebBrowserEventHandler):
    """
    description
    """
    def __init__(self):
        super(BrowserEventHandler, self).__init__()

    def CallCustomHandle(self, params):
        CommonUtils.SecurePrint('InvokePyFun')
        CommonUtils.SecurePrint(params)
        return 1

class MainFrame(PyFrameBase):
    def __init__(self):
        super(MainFrame, self).__init__()
        self.clsName = self.__class__.__name__
        self.skinFileName = self.__class__.__name__ + '.xml'

    # 不要改动
    def GetSkinFile(self):
        return self.skinFileName

    # 不要改动
    def GetWindowClassName(self):
        return self.clsName

    # 退出处理
    def OnClose(self, uMsg, wParam, lParam):
        windll.kernel32.ExitProcess(0)
        return 0

    def _HandleCommandFromJs(self, params):
        try:
            self.ret2js = '{"ret" : 1, "msg" : "处理失败", "content" : null }'

            paramsjson = json.loads(params)
            

            if paramsjson['fun'] == "func1":
                self.ret2js = '{"ret" : 0, "msg":"处理成功", "content" : null}'
                windll.user32.MessageBoxW(self.GetHWnd(),
                                                '这是python弹出的对话框',
                                                "提示",
                                                win32con.MB_ICONWARNING | win32con.MB_YESNO)

            elif paramsjson['fun'] == "func2":
                self.ret2js = '{"ret" : 0, "msg":"处理成功", "content" : null}'

            elif paramsjson['fun'] == "func3":
                self.msg = U2G('这个消息 是python 调用js传过来的')
                self.MyRobotBrowser.CallJs(id(self.msg))
                self.ret2js = '{"ret" : 0, "msg" : "处理成功", "content" : { "xxxxxx" : 1 } }'

        except:
            CommonUtils.SecurePrint(traceback.format_exc())

        self.retid2 = U2G(self.ret2js)
        return id(self.retid2)


    # virtual LRESULT HandleCustomMessage(UINT uMsg, WPARAM wParam, LPARAM lParam);
    def HandleCustomMessageInternal(self, uMsg, wParam, lParam):
        """
        description
        """
        if uMsg == WM_FROM_IEWEBBROWSER:
            CommonUtils.SecurePrint('加载完成：' + G2U(string_at(wParam)))

        elif uMsg == WM_FROM_JS:
            print(G2U(string_at(wParam)))
            # print(G2U(bytes(wParam)))
            return self._HandleCommandFromJs(G2U(string_at(wParam)))

        return 0
    
    # 准备显示前的处理
    def OnPrepare(self, sendor, wParam, lParam):
        # 声明控件
        self.FunctionTabs = self.PyFindTabLayout("FunctionTabs")
        self.MyRobotBrowser = self.PyFindWebBrowser("MyBrowser")

        self.MyRobotBrowser.SetWebBrowserEventHandler(BrowserEventHandler())
        self.MyRobotBrowser.SetHomePage(os.path.join(PyWin32Util.GetExeDirectory(), 'skin', 'index.html'))
        self.MyRobotBrowser.Navigate2(os.path.join(PyWin32Util.GetExeDirectory(), 'skin', 'index.html'))

    # 界面事件处理
    def OnNotify(self, sendor, sType, wParam, lParam):
        # 用户点击事件
        if sType == DUI_MSGTYPE_CLICK:
            if sendor == "minbtn":
                self.MinimizeWindow()
            elif sendor == "maxbtn":
                self.MaximizeWindow()
                
            elif sendor == "restorebtn":
                self.RestoreWindow()
                
            elif sendor == "closebtn":
                self.CloseWindow()
                